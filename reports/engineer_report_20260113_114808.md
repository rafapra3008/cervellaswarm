# ANALISI MIRACOLLOOK - Report Ingegnera
**Data:** 13 Gennaio 2026  
**Progetto:** miracollook (Email Client AI)  
**Analizzato da:** Cervella Ingegnera  
**Health Score:** 7.5/10

---

## EXECUTIVE SUMMARY

**Status:** BUONO - MVP funzionante con alcune aree da migliorare

**Cosa Funziona BENE:**
- Backend API completo (17 endpoint)
- Frontend React con layout three-panel pulito
- OAuth Gmail integrato con persistenza DB
- AI Summarization con Claude Haiku
- Keyboard shortcuts implementati

**Cosa MANCA:**
- Features email client professionali (drag&drop, resize, attachments view)
- Hotel workflow specifico (PMS integration, assign, templates)
- Performance ottimizzazioni (file troppo grandi)

---

## 1. COSA ESISTE (DONE)

### Backend API (17 endpoints)

**File:** `backend/gmail/api.py` (1391 righe - ‚ö†Ô∏è TROPPO GRANDE)

| Categoria | Endpoints | Status |
|-----------|-----------|--------|
| **Auth** | login, callback, status, logout | ‚úÖ Funzionante |
| **Read** | inbox, message, archived, starred, snoozed, trash | ‚úÖ Funzionante |
| **Write** | send, reply (con reply_all), forward | ‚úÖ Funzionante |
| **Actions** | archive, trash, untrash, star, unstar, snooze | ‚úÖ Funzionante |
| **Search** | search (Gmail query) | ‚úÖ Funzionante |
| **AI** | message/summary, inbox/summaries | ‚úÖ Funzionante |

**Database:**
- SQLite con SQLAlchemy
- Modello `UserToken` per OAuth persistence
- Single-user MVP (primo record = utente corrente)

**AI Integration:**
- Claude Haiku per email summaries
- Cache summaries in-memory
- Batch processing (max 20 email)

### Frontend Components

**Layout:** Three-panel fisso (Sidebar + List + Detail)

| Componente | Righe | Complessit√† | Note |
|------------|-------|-------------|------|
| App.tsx | 396 | ‚ö†Ô∏è ALTA | Gestisce tutto lo stato |
| Sidebar | 179 | OK | Navigazione + categorie |
| EmailList | 206 | OK | Lista con bundles |
| EmailDetail | 102 | OK | Viewer email |
| ComposeModal | 224 | ‚ö†Ô∏è MEDIO | Form invio |
| ReplyModal | 254 | ‚ö†Ô∏è MEDIO | Form risposta |
| ForwardModal | 226 | ‚ö†Ô∏è MEDIO | Form inoltro |
| GuestSidebar | 159 | OK | Sidebar ospite (mock) |
| SearchBar | 108 | OK | Ricerca con debounce |
| CommandPalette | 161 | OK | Cmd+K shortcuts |

**Features UI:**
- ‚úÖ Dark mode premium (Superhuman-like)
- ‚úÖ Keyboard shortcuts (J/K/C/R/F/E/#//)
- ‚úÖ Command Palette (Cmd+K)
- ‚úÖ Smart Bundles (11 regole di categorizzazione)
- ‚úÖ Toast feedback
- ‚úÖ Auth guard con loading state
- ‚úÖ React Query con auto-refresh (30s)

**Design System:**
- Tailwind CSS v4
- Font: Inter
- Colors: miracollo-bg, miracollo-accent, miracollo-text

---

## 2. COSA MANCA - EMAIL CLIENT PROFESSIONALE

### 2.1 UI/UX Essenziali

| Feature | Priorit√† | Difficolt√† | Note |
|---------|----------|------------|------|
| **Resize pannelli** | üî¥ ALTA | MEDIA | Drag divisore tra list/detail |
| **Column sorting** | üü° MEDIA | BASSA | Sort by date/sender/subject |
| **Drag & Drop** | üü¢ BASSA | ALTA | Email ‚Üí cartelle |
| **Multi-select** | üü° MEDIA | MEDIA | Azioni batch (archive 10 email) |
| **Undo actions** | üü° MEDIA | MEDIA | Toast con "Undo" dopo archive/trash |

### 2.2 Attachments

| Feature | Priorit√† | Difficolt√† | Note |
|---------|----------|------------|------|
| **View attachments** | üî¥ ALTA | MEDIA | Lista attachments in email detail |
| **Download attachment** | üî¥ ALTA | BASSA | Gmail API gi√† supporta |
| **Preview PDF/IMG** | üü° MEDIA | ALTA | Viewer inline |
| **Upload attachments** | üî¥ ALTA | MEDIA | Compose/Reply con file |
| **Attachment search** | üü¢ BASSA | MEDIA | has:attachment query |

### 2.3 Contatti & Signatures

| Feature | Priorit√† | Difficolt√† | Note |
|---------|----------|------------|------|
| **Contacts management** | üü° MEDIA | ALTA | Google Contacts API |
| **Auto-complete To/Cc** | üü° MEDIA | MEDIA | Ricerca contatti |
| **Email signatures** | üü° MEDIA | BASSA | Template HTML footer |
| **Signature per user** | üü¢ BASSA | MEDIA | Multi-signature support |

### 2.4 Folders/Labels

| Feature | Priorit√† | Difficolt√† | Note |
|---------|----------|------------|------|
| **Custom labels UI** | üü° MEDIA | MEDIA | Sidebar con tutte le label |
| **Create/Edit labels** | üü¢ BASSA | BASSA | Gmail API labels |
| **Label colors** | üü¢ BASSA | BASSA | UI design |
| **Apply labels** | üü° MEDIA | BASSA | Modify API gi√† esiste |

### 2.5 Search Avanzata

| Feature | Priorit√† | Difficolt√† | Note |
|---------|----------|------------|------|
| **Advanced search UI** | üü° MEDIA | MEDIA | Modal con form |
| **Search filters** | üü° MEDIA | BASSA | from:, to:, subject:, has: |
| **Save searches** | üü¢ BASSA | MEDIA | Saved queries |
| **Recent searches** | üü¢ BASSA | BASSA | Local storage |

### 2.6 Offline & Performance

| Feature | Priorit√† | Difficolt√† | Note |
|---------|----------|------------|------|
| **Offline mode** | üü¢ BASSA | ALTA | Service worker + IndexedDB |
| **Email caching** | üü° MEDIA | MEDIA | React Query persistenza |
| **Lazy loading** | üü° MEDIA | MEDIA | Infinite scroll lista |
| **Image lazy load** | üü¢ BASSA | BASSA | EmailDetail images |

### 2.7 Notifications

| Feature | Priorit√† | Difficolt√† | Note |
|---------|----------|------------|------|
| **Desktop notifications** | üü° MEDIA | MEDIA | Web Notifications API |
| **Unread badge** | üü° MEDIA | BASSA | Tab favicon + count |
| **Sound alerts** | üü¢ BASSA | BASSA | Audio player |
| **Push notifications** | üü¢ BASSA | ALTA | Service worker |

---

## 3. COSA MANCA - HOTEL WORKFLOW (LA MAGIA!)

### 3.1 PMS Integration (FASE 2 - CRITICA!)

| Feature | Priorit√† | Difficolt√† | Note |
|---------|----------|------------|------|
| **Identify guest** | üî¥ CRITICA | ALTA | Match email ‚Üí guest DB |
| **Show booking context** | üî¥ CRITICA | MEDIA | GuestSidebar con dati reali |
| **Link to PMS** | üî¥ CRITICA | MEDIA | API Miracollo |
| **Guest history** | üü° MEDIA | MEDIA | Past bookings/emails |

### 3.2 Assign & Team

| Feature | Priorit√† | Difficolt√† | Note |
|---------|----------|------------|------|
| **Assign to user** | üî¥ ALTA | MEDIA | Custom label per user |
| **Team inbox** | üü° MEDIA | ALTA | Shared view |
| **Assign notifications** | üü° MEDIA | MEDIA | Notifica quando assigned |
| **Status tracking** | üü¢ BASSA | MEDIA | Pending/Answered/Closed |

### 3.3 Templates Risposte (FASE 3)

| Feature | Priorit√† | Difficolt√† | Note |
|---------|----------|------------|------|
| **Quick replies** | üî¥ ALTA | BASSA | Template storage |
| **Template categories** | üü° MEDIA | BASSA | Check-in, Check-out, Info |
| **Variables support** | üî¥ ALTA | MEDIA | {{guest_name}}, {{room}} |
| **Template editor** | üü° MEDIA | MEDIA | UI per creare template |

### 3.4 Preventivi Auto (FASE 3)

| Feature | Priorit√† | Difficolt√† | Note |
|---------|----------|------------|------|
| **Detect quote request** | üî¥ ALTA | ALTA | AI parsing email |
| **Generate quote** | üî¥ ALTA | ALTA | PMS ‚Üí PDF |
| **1-click send quote** | üî¥ ALTA | MEDIA | Attach + reply |
| **Quote tracking** | üü° MEDIA | MEDIA | Status: sent/opened/accepted |

### 3.5 Document AI (FASE 4)

| Feature | Priorit√† | Difficolt√† | Note |
|---------|----------|------------|------|
| **Extract from email** | üü° MEDIA | ALTA | AI estrae dati |
| **Auto-fill PMS** | üü° MEDIA | ALTA | API Miracollo |
| **Document types** | üü° MEDIA | MEDIA | ID, booking confirm, invoice |
| **Validation UI** | üü° MEDIA | MEDIA | Review prima di salvare |

---

## 4. TECHNICAL DEBT

### 4.1 File Troppo Grandi (CRITICO)

**File:** `backend/gmail/api.py` - **1391 righe** ‚ö†Ô∏è

**Problema:**
- Tutti gli endpoint in un file
- Difficile manutenzione
- Violazione Single Responsibility

**Suggerimento Split:**
```
backend/gmail/
‚îú‚îÄ‚îÄ endpoints/
‚îÇ   ‚îú‚îÄ‚îÄ auth.py         # OAuth endpoints
‚îÇ   ‚îú‚îÄ‚îÄ read.py         # inbox, message, views
‚îÇ   ‚îú‚îÄ‚îÄ write.py        # send, reply, forward
‚îÇ   ‚îú‚îÄ‚îÄ actions.py      # archive, trash, star, snooze
‚îÇ   ‚îú‚îÄ‚îÄ search.py       # search endpoint
‚îÇ   ‚îî‚îÄ‚îÄ ai.py           # summaries
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ gmail.py        # get_gmail_service, helpers
‚îÇ   ‚îî‚îÄ‚îÄ message.py      # create_message, create_reply_message
‚îî‚îÄ‚îÄ api.py              # Router aggregator
```

**Effort:** 4-6 ore  
**Benefit:** Manutenibilit√†, testabilit√†, team collaboration

### 4.2 Funzioni Troppo Grandi

| File | Funzione | Righe | Soglia | Azione |
|------|----------|-------|--------|--------|
| gmail/api.py | `reply_email` | 152 | 50 | üî¥ Estrai logica reply_all |
| gmail/api.py | `get_inbox_summaries` | 103 | 50 | üü° Estrai batch processing |
| Compose/Reply/ForwardModal | render | 169-199 | 100 | üü° Estrai sub-components |
| App.tsx | AppContent | 120 | 100 | üü° Estrai hooks custom |

### 4.3 Duplicazioni

**Pattern identificati:**

1. **Email fetching (4x duplicato):**
   - `get_inbox`, `get_archived`, `get_starred`, `get_snoozed`, `get_trash`
   - Stessa logica: list ‚Üí get metadata ‚Üí parse headers
   - **Fix:** Estrai `fetch_emails_by_query(query, max_results)`

2. **Modal form (3x duplicato):**
   - ComposeModal, ReplyModal, ForwardModal
   - Stessa struttura: form + send logic + toast
   - **Fix:** EmailFormModal con props configurabili

3. **Error handling (ripetuto ovunque):**
   - Try/catch con stesso pattern
   - **Fix:** Decorator o middleware

### 4.4 Mancanza Testing

**Coverage:** 0% ‚ö†Ô∏è

| Tipo | Priorit√† | Note |
|------|----------|------|
| **Backend unit tests** | üî¥ ALTA | pytest per endpoints |
| **Frontend unit tests** | üü° MEDIA | vitest + react-testing-library |
| **E2E tests** | üü° MEDIA | Playwright |
| **API integration tests** | üî¥ ALTA | Gmail API mock |

### 4.5 Sicurezza

| Issue | Priorit√† | Fix |
|-------|----------|-----|
| **Token in DB plaintext** | üî¥ ALTA | Encrypt tokens |
| **No rate limiting** | üü° MEDIA | FastAPI limiter |
| **No CSRF protection** | üü° MEDIA | CSRF tokens |
| **No input sanitization** | üü° MEDIA | Validator middleware |

### 4.6 Performance

| Issue | Impact | Fix |
|-------|--------|-----|
| **Inbox refresh (30s)** | MEDIO | WebSocket per push |
| **No pagination** | ALTO | Infinite scroll + pagination |
| **Bundle re-compute ogni render** | BASSO | useMemo pi√π granulare |
| **No email cache** | MEDIO | React Query persistenza |

---

## 5. ARCHITETTURA - STATO ATTUALE

### Backend
```
FastAPI
‚îú‚îÄ‚îÄ main.py                    # Entry point
‚îú‚îÄ‚îÄ auth/google.py             # OAuth2 flow
‚îú‚îÄ‚îÄ gmail/api.py               # üî¥ MONOLITE (1391 righe)
‚îú‚îÄ‚îÄ ai/claude.py               # AI summaries
‚îî‚îÄ‚îÄ db/
    ‚îú‚îÄ‚îÄ database.py            # SQLAlchemy setup
    ‚îî‚îÄ‚îÄ models.py              # UserToken model
```

**Pro:**
- ‚úÖ Struttura chiara
- ‚úÖ Separazione concerns (auth, gmail, ai, db)

**Contro:**
- ‚ö†Ô∏è gmail/api.py troppo grande
- ‚ö†Ô∏è No service layer
- ‚ö†Ô∏è No tests

### Frontend
```
React + TypeScript
‚îú‚îÄ‚îÄ App.tsx                    # Main app + routing
‚îú‚îÄ‚îÄ components/                # UI components
‚îÇ   ‚îú‚îÄ‚îÄ Auth/                  # Login
‚îÇ   ‚îú‚îÄ‚îÄ Layout/                # ThreePanel
‚îÇ   ‚îú‚îÄ‚îÄ Sidebar/               # Navigation
‚îÇ   ‚îú‚îÄ‚îÄ EmailList/             # Lista + bundles
‚îÇ   ‚îú‚îÄ‚îÄ EmailDetail/           # Viewer
‚îÇ   ‚îú‚îÄ‚îÄ Compose/               # Form nuova email
‚îÇ   ‚îú‚îÄ‚îÄ Reply/                 # Form risposta
‚îÇ   ‚îú‚îÄ‚îÄ Forward/               # Form inoltro
‚îÇ   ‚îú‚îÄ‚îÄ GuestSidebar/          # Hotel context
‚îÇ   ‚îú‚îÄ‚îÄ Search/                # SearchBar
‚îÇ   ‚îú‚îÄ‚îÄ CommandPalette/        # Cmd+K
‚îÇ   ‚îî‚îÄ‚îÄ HelpModal/             # Help shortcuts
‚îú‚îÄ‚îÄ hooks/                     # useAuth, useEmails, useKeyboard
‚îú‚îÄ‚îÄ services/                  # API calls
‚îú‚îÄ‚îÄ types/                     # TypeScript types
‚îî‚îÄ‚îÄ utils/                     # categorize, bundles
```

**Pro:**
- ‚úÖ Component organization chiara
- ‚úÖ Hooks custom ben separati
- ‚úÖ TypeScript strict

**Contro:**
- ‚ö†Ô∏è App.tsx gestisce troppo stato (120 righe funzione)
- ‚ö†Ô∏è Modal forms duplicati
- ‚ö†Ô∏è No state management (Context/Zustand)

---

## 6. RACCOMANDAZIONI PRIORITIZZATE

### üî¥ CRITICO (Fare SUBITO)

1. **Split gmail/api.py** (Effort: 6h)
   - Migliorabilit√† urgente
   - Blocca scaling team

2. **Attachments support** (Effort: 12h)
   - View, download, upload
   - Feature essenziale email client

3. **Testing suite** (Effort: 16h)
   - Backend pytest
   - Frontend vitest
   - Previene regressioni

4. **PMS Integration planning** (Effort: 2h)
   - API contract con Miracollo
   - Database schema guest linking
   - Prepara FASE 2 (LA MAGIA!)

### üü° ALTO (Pianificare)

5. **Resize pannelli** (Effort: 4h)
   - UX professionale
   - React-resizable-panels

6. **Template risposte** (Effort: 8h)
   - Hotel workflow essenziale
   - DB + UI + variables

7. **Multi-select + batch actions** (Effort: 6h)
   - Efficienza operativa

8. **Search avanzata UI** (Effort: 4h)
   - Miglior UX ricerca

### üü¢ MEDIO (Backlog)

9. **Contacts management** (Effort: 12h)
10. **Custom labels UI** (Effort: 6h)
11. **Offline mode** (Effort: 16h)
12. **Desktop notifications** (Effort: 4h)

---

## 7. METRICHE

| Metrica | Valore | Soglia | Status |
|---------|--------|--------|--------|
| File > 500 righe | 1 | 0 | ‚ö†Ô∏è |
| Funzioni > 50 righe | 31 | < 10 | ‚ö†Ô∏è |
| TODO/FIXME | 0 | 0 | ‚úÖ |
| Test coverage | 0% | > 70% | ‚ùå |
| Duplicazioni | 3 pattern | 0 | ‚ö†Ô∏è |
| Total LOC | 7734 | - | OK |
| Files | 60 | - | OK |

---

## 8. VERDICT FINALE

**Health Score: 7.5/10**

**Punti di Forza:**
- ‚úÖ MVP funzionante e pulito
- ‚úÖ Backend API completo
- ‚úÖ UI professionale (Superhuman-like)
- ‚úÖ AI integration gi√† presente
- ‚úÖ Architettura chiara

**Aree Critiche:**
- ‚ö†Ô∏è File `gmail/api.py` troppo grande (1391 righe)
- ‚ö†Ô∏è Manca testing (0% coverage)
- ‚ö†Ô∏è Mancano features essenziali (attachments, resize, templates)
- ‚ö†Ô∏è PMS integration non ancora iniziata (FASE 2)

**Pronti per:**
- ‚úÖ Demo MVP
- ‚úÖ Test con utenti interni
- ‚ö†Ô∏è Produzione (dopo refactoring + tests)

**NON pronti per:**
- ‚ùå Hotel workflow reale (serve PMS integration)
- ‚ùå Team collaboration (serve assign + multi-user)
- ‚ùå Produzione critica (serve testing)

---

## 9. NEXT STEPS SUGGERITI

**Questa settimana:**
1. Split `gmail/api.py` in moduli (6h)
2. Attachments view + download (4h)

**Prossima settimana:**
1. Testing backend (8h)
2. Resize pannelli (4h)
3. Template risposte (8h)

**Mese corrente:**
1. PMS Integration planning + API (16h)
2. Guest recognition (8h)
3. Testing frontend (8h)

---

**Firmato:** Cervella Ingegnera  
**Data:** 13 Gennaio 2026, ore 13:47  

*"Il codice √® buono, ma pu√≤ diventare OTTIMO!"*
